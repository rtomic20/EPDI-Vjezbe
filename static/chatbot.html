<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <title>Arhitekt Chatbot</title>
  <style>
    :root {
      --main-bg: #23272e;
      --chat-bg: #23272e;
      --header-bg: #144a52;
      --bubble-user: #2196F3;
      --bubble-user-color: #fff;
      --bubble-bot: #e0f7fa;
      --bubble-bot-color: #23272e;
      --bubble-file-bg: #77d2fe;
      --bubble-file-color: #00324a;
      --input-bg: #35506d;
      --border: #b3dfff;
      --footer-bg: #217eae;
      --button-bg: #07c2f6;
      --button-hover: #2bddff;
    }
    body.light {
      --main-bg: #f0f2f5;
      --chat-bg: #fff;
      --header-bg: #00BED2;
      --bubble-user: #e0f7fa;
      --bubble-user-color: #028395FF;
      --bubble-bot: #028395;
      --bubble-bot-color: #fff;
      --bubble-file-bg: #eaf5ff;
      --bubble-file-color: #007be3;
      --input-bg: #f9f9f9;
      --border: #ccc;
      --footer-bg: #fafafa;
      --button-bg: #00BED2;
      --button-hover: #009FB0;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--main-bg);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      color: #fff;
      transition: background 0.2s, color 0.2s;
    }
    .chat-container {
      background: var(--chat-bg);
      width: 80%;
      max-width: 1100px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.10);
      display: flex;
      border-radius: 12px;
      overflow: hidden;
      flex-direction: column;
      height: 90vh;
      max-height: 90vh;
      transition: background 0.2s;
    }
    .chat-header {
      flex: 0 0 60px;
      display: flex;
      align-items: center;
      background-color: var(--header-bg);
      padding: 15px;
      justify-content: space-between;
      box-sizing: border-box;
      transition: background 0.2s;
    }
    .chat-header-left {
      display: flex;
      align-items: center;
    }
    .chat-header img {
      height: 40px;
      margin-right: 15px;
    }
    .chat-header p {
      margin: 0;
      color: #fff;
      font-weight: 600;
    }
    .theme-toggle {
      background: #fff3;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 19px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .theme-toggle:hover {
      background: #fff6;
      color: gold;
    }
    #chatbox {
      flex: 1 1 auto;
      padding: 18px;
      overflow-y: auto;
      background: var(--chat-bg);
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      color: #fff;
      transition: background 0.2s, color 0.2s;
    }
    body.light #chatbox {
      color: #23272e;
    }
    .message {
      display: flex;
      align-items: flex-start;
      margin: 10px 0;
      max-width: 83%;
      animation: fadeIn 0.3s ease-in;
      word-break: break-word;
    }
    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    .message.bot {
      align-self: flex-start;
    }
    .message.file {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    .avatar {
      width: 32px;
      height: 32px;
      margin: 0 10px;
      object-fit: contain;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 0 2px #ccc;
    }
    .bubble {
      padding: 18px 26px 18px 26px;
      border-radius: 22px;
      line-height: 1.8;
      font-size: 17px;
      position: relative;
      color: #2a3d4d;
      background: var(--bubble-bot);
      color: var(--bubble-bot-color);
      text-align: left;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 16px 0 #01171c14;
      letter-spacing: 0.1px;
    }
    .user .bubble {
      background: var(--bubble-user);
      color: var(--bubble-user-color);
      align-items: flex-end;
      text-align: right;
    }
    .bot .bubble {
      background: var(--bubble-bot);
      color: var(--bubble-bot-color);
    }
    .file .bubble {
      background: var(--bubble-file-bg);
      color: var(--bubble-file-color);
      border: 1px solid #fff;
      font-size: 16px;
      gap: 10px;
      align-items: center;
      flex-direction: row;
    }
    .bubble .file-icon {
      font-size: 22px;
      margin-right: 6px;
      color: var(--bubble-file-color);
    }
    .detail-actions {
      margin-top: 22px;
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 15px;
    }
    .detail-actions button {
      margin: 0 4px;
      padding: 7px 17px;
      border-radius: 9px;
      border: none;
      font-size: 15px;
      line-height: 1.4;
      background: var(--button-bg);
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      transition: background .18s;
      white-space: nowrap;
      box-shadow: 0 1px 7px #0002;
    }
    .detail-actions button:hover {
      background: var(--button-hover);
    }
    .input-area {
      flex: 0 0 60px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      background: var(--input-bg);
      border-top: 2px solid var(--border);
      box-sizing: border-box;
      color: #fff;
      transition: background 0.2s, color 0.2s;
    }
    body.light .input-area {
      color: #23272e;
    }
    #fileInput {
      display: none;
    }
    .custom-file-label {
      background: var(--button-bg);
      color: #fff;
      border-radius: 5px;
      padding: 10px 18px;
      cursor: pointer;
      margin-right: 4px;
      font-size: 15px;
      border: none;
      transition: background 0.16s;
      display: flex;
      align-items: center;
      font-weight: 600;
      box-shadow: 0 2px 12px 0 #01171c38;
    }
    .custom-file-label:hover {
      background: var(--button-hover);
    }
    #input {
      flex: 1;
      padding: 10px 15px;
      border-radius: 5px;
      border: 2px solid var(--border);
      font-size: 16px;
      background: #23272e;
      color: #fff;
      margin: 0 4px;
      transition: background 0.2s, color 0.2s;
    }
    body.light #input {
      background: #fff;
      color: #23272e;
    }
    #sendBtn {
      background: var(--button-bg);
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 10px 18px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.16s;
      font-weight: bold;
      box-shadow: 0 2px 10px 0 #01171c3a;
    }
    #sendBtn:hover {
      background: var(--button-hover);
    }
    .footer {
      flex: 0 0 48px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 12px 18px;
      border-top: 2px solid var(--border);
      background: var(--footer-bg);
      box-sizing: border-box;
      transition: background 0.2s;
    }
    .footer img {
      height: 30px;
      opacity: 0.93;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px);}
      to { opacity:1; transform: translateY(0);}
    }
    .file-preview-hidden {
      display: none !important;
    }
    .file-preview {
      background: var(--bubble-file-bg);
      color: var(--bubble-file-color);
      border-radius: 5px;
      font-size: 16px;
      padding: 8px 16px;
      margin-right: 8px;
      border: 1.5px solid var(--border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .remove-file {
      background: none;
      border: none;
      margin-left: 6px;
      color: #e32222;
      cursor: pointer;
      font-size: 20px;
      padding: 0;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="chat-header-left">
        <img src="static/logo.svg" alt="Logo" />
        <p>Gemini</p>
      </div>
      <button class="theme-toggle" id="themeToggle" title="Promijeni temu">üåô</button>
    </div>
    <div id="chatbox"></div>
    <div class="input-area">
      <label for="fileInput" class="custom-file-label" id="fileLabel">Odaberi datoteku</label>
      <input id="fileInput" type="file" accept=".pdf,.docx,.txt" />
      <span id="filePreview" class="file-preview-hidden"></span>
      <input id="input" type="text" placeholder="Postavite pitanje..." autocomplete="off" />
      <button id="sendBtn">Po≈°alji</button>
    </div>
    <div class="footer">
      <img src="static/logo-edih.png" alt="EDIH Partner Logo" />
    </div>
  </div>
  <script>
    const themeToggle = document.getElementById('themeToggle');
    const SESSION_ID = crypto.randomUUID();
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const chatbox = document.getElementById("chatbox");
    const fileInput = document.getElementById("fileInput");
    const fileLabel = document.getElementById("fileLabel");
    const filePreview = document.getElementById("filePreview");

    let isLightTheme = false;
    let currentFile = null;

    themeToggle.addEventListener("click", () => {
      isLightTheme = !isLightTheme;
      document.body.classList.toggle("light", isLightTheme);
      themeToggle.textContent = isLightTheme ? "üåô" : "‚òÄÔ∏è";
    });

    fileInput.addEventListener('change', async function() {
      if (!this.files[0]) {
        fileLabel.textContent = 'Odaberi datoteku';
        filePreview.classList.add('file-preview-hidden');
        filePreview.textContent = '';
        currentFile = null;
        return;
      }
      const filename = this.files[0].name;
      fileLabel.textContent = '';
      filePreview.classList.remove('file-preview-hidden');
      filePreview.innerHTML = `<span class="file-icon">üìÑ</span>${filename}<button class="remove-file" title="Ukloni" type="button">&times;</button>`;
      filePreview.querySelector('.remove-file').onclick = function() {
        fileInput.value = '';
        filePreview.classList.add('file-preview-hidden');
        fileLabel.textContent = 'Odaberi datoteku';
        filePreview.textContent = '';
        currentFile = null;
      };
      const fd = new FormData();
      fd.append("file", this.files[0]);
      fd.append("session_id", SESSION_ID);
      try {
        const res = await fetch("http://localhost:5000/upload", {
          method: "POST",
          body: fd,
        });
        const data = await res.json();
        if (data.ok) {
          currentFile = filename;
          appendFileMessage(filename);
        } else {
          filePreview.classList.add('file-preview-hidden');
          fileLabel.textContent = 'Odaberi datoteku';
          filePreview.textContent = '';
          currentFile = null;
          alert("Gre≈°ka pri slanju datoteke: " + (data.error || "Nepoznata gre≈°ka"));
        }
      } catch (err) {
        filePreview.classList.add('file-preview-hidden');
        fileLabel.textContent = 'Odaberi datoteku';
        filePreview.textContent = '';
        currentFile = null;
        alert("Gre≈°ka pri spajanju na server!");
      }
    });

    function appendFileMessage(filename) {
      const msg = document.createElement("div");
      msg.className = "message file";
      const avatar = document.createElement("img");
      avatar.className = "avatar";
      avatar.src = "static/user-icon.png";
      avatar.alt = "user";
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      const icon = document.createElement("span");
      icon.className = "file-icon";
      icon.textContent = "üìÑ";
      bubble.appendChild(icon);
      bubble.appendChild(document.createTextNode(filename));
      msg.appendChild(avatar);
      msg.appendChild(bubble);
      chatbox.appendChild(msg);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function appendMessage(sender, content, detailedContent) {
      const msg = document.createElement("div");
      msg.className = "message " + sender;
      const avatar = document.createElement("img");
      avatar.className = "avatar";
      avatar.src = sender === "user" ? "static/user-icon.png" : "static/edit-chatbot.png";
      avatar.alt = sender;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      if (detailedContent) {
        const textDiv = document.createElement("div");
        textDiv.className = "text-part";
        textDiv.innerHTML = content;
        bubble.appendChild(textDiv);

        const actions = document.createElement("div");
        actions.className = "detail-actions";
        const hint = document.createElement("span");
        hint.textContent = "≈Ωelite li detaljnije obja≈°njenje?";
        actions.appendChild(hint);
        const button = document.createElement("button");
        button.textContent = "Prika≈æi detaljno";
        let expanded = false;
        button.onclick = () => {
          expanded = !expanded;
          textDiv.innerHTML = expanded ? detailedContent : content;
          button.textContent = expanded ? "Sa≈æmi" : "Prika≈æi detaljno";
        };
        actions.appendChild(button);

        bubble.appendChild(actions);
      } else {
        bubble.innerHTML = content;
      }
      msg.appendChild(avatar);
      msg.appendChild(bubble);
      chatbox.appendChild(msg);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function appendBotMessage(content, detailedContent) {
      appendMessage("bot", content, detailedContent);
    }

    let typingMsg = null;
    let typingInterval = null;

    function showTyping() {
      typingMsg = document.createElement("div");
      typingMsg.className = "message bot";
      const avatar = document.createElement("img");
      avatar.className = "avatar";
      avatar.src = "static/edit-chatbot.png";
      avatar.alt = "bot";
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerText = "Bot pi≈°e";
      typingMsg.appendChild(avatar);
      typingMsg.appendChild(bubble);
      chatbox.appendChild(typingMsg);
      chatbox.scrollTop = chatbox.scrollHeight;
      let dots = 0;
      typingInterval = setInterval(() => {
        dots = (dots + 1) % 4;
        bubble.innerText = "Bot pi≈°e" + ".".repeat(dots);
      }, 500);
    }

    function hideTyping() {
      if (typingMsg) {
        clearInterval(typingInterval);
        chatbox.removeChild(typingMsg);
        typingMsg = null;
      }
    }

    async function sendMessage() {
      const message = input.value.trim();
      if (!message) return;
      appendMessage("user", message);
      input.value = "";
      showTyping();
      let responseObj;
      try {
        const res = await fetch("http://localhost:5000/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: message,
            session_id: SESSION_ID,
          }),
        });
        responseObj = await res.json();
      } catch (e) {
        hideTyping();
        appendBotMessage("Gre≈°ka s komunikacijom prema serveru.");
        return;
      }
      hideTyping();
      if (responseObj.short && responseObj.detailed) {
        window.lastDetailed = responseObj.detailed;
        appendBotMessage(responseObj.short, responseObj.detailed);
      } else if (responseObj.reply) {
        appendBotMessage(responseObj.reply);
      } else {
        appendBotMessage("Nije stigao oƒçekivani odgovor sa servera.");
      }
      fileInput.value = '';
      filePreview.classList.add('file-preview-hidden');
      fileLabel.textContent = 'Odaberi datoteku';
      filePreview.textContent = '';
      currentFile = null;
    }

    input.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });
    sendBtn.addEventListener("click", sendMessage);
    fileLabel.addEventListener("click", () => fileInput.click());

    input.focus();
  </script>
</body>
</html>
